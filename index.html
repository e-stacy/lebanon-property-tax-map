<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Lebanon Property Tax Database</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: system-ui, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .header {
            background: white;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 { 
            margin: 0; 
            color: #2c3e50;
            font-size: 1.4em;
            font-weight: 500;
        }
        .subtitle { 
            color: #666; 
            font-size: 0.85em;
            margin-top: 2px;
        }
        .header-right {
            flex-shrink: 0;
        }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 8px; 
            margin-bottom: 12px;
        }
        .stat-card { 
            background: white;
            border-radius: 6px; 
            padding: 8px 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            min-width: 0;
        }
        .stat-number { 
            font-size: 1.1em; 
            font-weight: bold; 
            color: #2c3e50;
            margin-bottom: 2px;
        }
        .stat-label { 
            color: #666; 
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 12px; 
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 140px;
        }
        .control-label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input, select { 
            padding: 8px 10px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="search"] {
            min-width: 150px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow-y: auto;
            overflow-x: scroll; /* Always show horizontal scrollbar */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 80px; /* Space for fixed pagination */
            max-height: calc(100vh - 320px); /* Optimized height for more rows */
            border: 1px solid #e1e5e9;
        }
        .pagination {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e1e5e9;
            padding: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .page-btn:hover { background: #f5f5f5; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .filter-stats {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 0.9em;
            color: #1976d2;
            display: none;
        }
        table { 
            width: 100%; 
            min-width: 1800px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td { 
            padding: 8px 10px; 
            text-align: left; 
            border-bottom: 1px solid #e1e5e9;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600;
            position: sticky; 
            top: 0;
            color: #2c3e50;
            cursor: col-resize;
            user-select: none;
            min-width: 80px;
        }
        th:hover {
            background: #e9ecef;
        }
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            z-index: 15;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .currency {
            text-align: right;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn-warning {
            background: #f39c12;
        }
        .btn-warning:hover {
            background: #d68910;
        }
        .analytics-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .analytics-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .compare-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .compare-property {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }
        .property-select {
            cursor: pointer;
            transition: all 0.2s;
        }
        .property-select:hover {
            background: #e3f2fd !important;
        }
        .property-select.selected {
            background: #bbdefb !important;
            border-left: 4px solid #2196f3;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            .action-buttons {
                justify-content: center;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Lebanon Property Tax Database</h1>
            <div class="subtitle">Comprehensive property assessment data for the City of Lebanon, NH</div>
        </div>
        <div class="header-right">
            <a href="map.html" style="background: #27ae60; color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px; font-size: 0.9em;">üó∫Ô∏è View Map</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="total-parcels">‚Äî</div>
            <div class="stat-label">Total Parcels</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="total-value">‚Äî</div>
            <div class="stat-label">Total Assessed Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="median-value">‚Äî</div>
            <div class="stat-label">Median Property Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="property-classes">‚Äî</div>
            <div class="stat-label">Property Classes</div>
        </div>
    </div>

    <div class="controls">
        <div class="control-row">
            <button class="btn" onclick="clearFilters()" style="margin-right: 15px; align-self: flex-end; margin-bottom: 6px;">üîÑ Reset Filters</button>
            <div class="control-group">
                <div class="control-label">Property Class <small style="color: #888;">(Ctrl+click for multiple)</small></div>
                <select id="class-filter" multiple size="1" style="min-height: 36px;">
                    <option value="">All Classes</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Year Built <small style="color: #888;">(Ctrl+click for multiple)</small></div>
                <select id="year-built-filter" multiple size="1" style="min-height: 36px;">
                    <option value="">All Years</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Zone <small style="color: #888;">(Ctrl+click for multiple)</small></div>
                <select id="zoning-filter" multiple size="1" style="min-height: 36px;">
                    <option value="">All Zones</option>
                </select>
            </div>
            <div class="control-group">
                <div class="control-label">Min Value ($)</div>
                <input id="min-value" type="number" placeholder="0" style="width: 100%;">
            </div>
            <div class="control-group">
                <div class="control-label">Max Value ($)</div>
                <input id="max-value" type="number" placeholder="Any" style="width: 100%;">
            </div>
        </div>
        <div style="color: #666; font-size: 0.9em;">
            Showing <span id="filtered-count">0</span> properties
            <span id="comparison-count" style="margin-left: 16px; color: #2196f3; display: none;">üìã <span id="selected-count">0</span> selected for comparison</span>
        </div>
    </div>

    <div id="filter-stats" class="filter-stats"></div>
    
    <div id="analytics-panel" class="analytics-panel">
        <h3 style="margin: 0 0 16px 0; color: #2c3e50;">üìà Property Analytics</h3>
        <div class="analytics-grid">
            <div class="analytics-card">
                <h4 style="margin: 0 0 8px 0;">Value Distribution</h4>
                <div id="value-distribution"></div>
            </div>
            <div class="analytics-card">
                <h4 style="margin: 0 0 8px 0;">Property Classes</h4>
                <div id="class-breakdown"></div>
            </div>
            <div class="analytics-card">
                <h4 style="margin: 0 0 8px 0;">Size Analysis</h4>
                <div id="size-analysis"></div>
            </div>
            <div class="analytics-card">
                <h4 style="margin: 0 0 8px 0;">Market Insights</h4>
                <div id="market-insights"></div>
            </div>
        </div>
    </div>
    
    <div id="compare-panel" class="compare-panel">
        <h3 style="margin: 0 0 16px 0; color: #2c3e50;">‚öñÔ∏è Property Comparison</h3>
        <div id="comparison-content">
            <p style="color: #666;">Select properties from the table below to compare them side by side.</p>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Parcel ID</th>
                    <th>Owner</th>
                    <th>Class</th>
                    <th title="Zoning district">Zone</th>
                    <th title="Architectural style">Style</th>
                    <th title="Construction quality grade">Grade</th>
                    <th>Year Built</th>
                    <th>Living Area (sqft)</th>
                    <th>Bedrooms</th>
                    <th title="Total rooms including bedrooms">Total Rooms</th>
                    <th title="Full bathrooms">Bathrooms</th>
                    <th title="Half bathrooms/powder rooms">Half Baths</th>
                    <th title="Primary heating system type">Heat Type</th>
                    <th title="Heating fuel source">Fuel</th>
                    <th title="Land neighborhood code">Neighborhood</th>
                    <th>Lot Size (acres)</th>
                    <th class="currency">Land Value</th>
                    <th class="currency">Building Value</th>
                    <th class="currency">Total Value</th>
                </tr>
            </thead>
            <tbody id="parcels-table">
                <tr>
                    <td colspan="19" class="loading">Loading property data...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="pagination" class="pagination"></div>

    <script>
        let allParcels = [];
        let filteredParcels = [];

        // Utility functions
        const formatCurrency = (value) => {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        };

        const formatNumber = (value) => {
            const num = parseFloat(value) || 0;
            return num.toLocaleString();
        };

        const parseNumber = (value) => {
            return parseFloat(String(value).replace(/[^0-9.-]/g, '')) || 0;
        };

        // Load data
        async function loadParcels() {
            try {
                const response = await fetch('data/parcels.csv');
                const text = await response.text();
                console.log('Raw CSV length:', text.length);
                
                // Parse CSV properly handling quoted fields
                const lines = text.trim().split('\n');
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                allParcels = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const parcel = {};
                    headers.forEach((header, index) => {
                        parcel[header] = values[index] || '';
                    });
                    return parcel;
                }).filter(p => p.parcel_id && p.parcel_id.trim());

                console.log(`Loaded ${allParcels.length} parcels`);
                if (allParcels.length > 0) {
                    console.log('First parcel:', allParcels[0]);
                }
                updateStats();
                populateFilters();
                applyFilters();
                
                // Initialize column resizing after table is rendered
                setTimeout(initializeColumnResizing, 100);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('parcels-table').innerHTML = '<tr><td colspan="19" class="no-results">Error loading data</td></tr>';
            }
        }

        // Enhanced features variables
        let selectedProperties = new Set();
        let comparisonMode = false;
        
        // Parse CSV line handling quoted fields properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Hierarchical property class structure for Lebanon, NH (standardized with map page)
        const propertyClassHierarchy = {
            '013R': { name: 'Seasonal Residential', primary: true },
            '0310': { name: 'Seasonal Land', primary: true },
            '0430': { name: 'Forest Land', primary: true },
            '1010': {
                name: 'Residential Single Family',
                primary: true,
                subclasses: ['1012', '101A', '101C', '101T']
            },
            '1012': { name: 'Residential Multi-Unit', parent: '1010' },
            '101A': { name: 'Residential Accessory', parent: '1010' },
            '101C': { name: 'Residential Commercial', parent: '1010' },
            '101T': { name: 'Residential Temp', parent: '1010' },
            
            '1020': {
                name: 'Manufactured Housing',
                primary: true,
                subclasses: ['102C', '102V']
            },
            '102C': { name: 'Manufactured Commercial', parent: '1020' },
            '102V': { name: 'Manufactured Village', parent: '1020' },
            
            '2010': {
                name: 'Commercial/Industrial',
                primary: true,
                subclasses: ['2020', '201C', '2030', '2040', '204C', '2050', '2060', '2070', '2080', '2090']
            },
            '2020': { name: 'Retail/Service', parent: '2010' },
            '201C': { name: 'Commercial Condo', parent: '2010' },
            '2030': { name: 'Office', parent: '2010' },
            '2040': { name: 'Industrial', parent: '2010' },
            '204C': { name: 'Industrial Condo', parent: '2010' },
            '2050': { name: 'Warehouse', parent: '2010' },
            '2060': { name: 'Special Purpose', parent: '2010' },
            '2070': { name: 'Mixed Use', parent: '2010' },
            '2080': { name: 'Auto Related', parent: '2010' },
            '2090': { name: 'Restaurant/Hotel', parent: '2010' },
            
            '3520': { name: 'Wild/Forest Land', primary: true },
            '3530': { name: 'Recreation Land', primary: true },
            '3540': { name: 'Cemeteries', primary: true },
            '354C': { name: 'Cemetery Commercial', parent: '3540' },
            '3550': { name: 'Other Land', primary: true },
            '4100': { name: 'Government/Municipal', primary: true },
            '5010': { name: 'Religious/Educational', primary: true },
            '9200': { name: 'Hospital', primary: true }
        };

        const lebanonClassCodes = Object.keys(propertyClassHierarchy);

        // Helper functions for property classes
        function getPrimaryClasses() {
            return Object.entries(propertyClassHierarchy)
                .filter(([code, info]) => info.primary)
                .map(([code, info]) => ({ code, name: info.name }));
        }
        
        function getClassesForFilter(selectedClasses) {
            const result = [];
            selectedClasses.forEach(selectedClass => {
                const classInfo = propertyClassHierarchy[selectedClass];
                if (!classInfo) {
                    result.push(selectedClass);
                    return;
                }
                
                // If it's a primary class with subclasses, include all subclasses
                if (classInfo.primary && classInfo.subclasses) {
                    result.push(selectedClass, ...classInfo.subclasses);
                } else {
                    result.push(selectedClass);
                }
            });
            return [...new Set(result)]; // Remove duplicates
        }

        // Update statistics
        function updateStats() {
            const totalParcels = allParcels.length;
            const totalValue = allParcels.reduce((sum, p) => sum + parseNumber(p.total_value), 0);
            const values = allParcels.map(p => parseNumber(p.total_value)).filter(v => v > 0).sort((a, b) => a - b);
            const medianValue = values.length > 0 ? values[Math.floor(values.length / 2)] : 0;
            // Count only valid property class codes
            const validClasses = new Set(allParcels.map(p => p.class_code).filter(c => lebanonClassCodes.includes(c)));

            document.getElementById('total-parcels').textContent = formatNumber(totalParcels);
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('median-value').textContent = formatCurrency(medianValue);
            document.getElementById('property-classes').textContent = formatNumber(validClasses.size);
        }

        // Populate filter dropdowns
        function populateFilters() {
            const classFilter = document.getElementById('class-filter');
            const yearFilter = document.getElementById('year-built-filter');
            const zoneFilter = document.getElementById('zoning-filter');
            
            // Clear existing options (keep "All" options)
            classFilter.innerHTML = '<option value="">All Classes</option>';
            yearFilter.innerHTML = '<option value="">All Years</option>';
            zoneFilter.innerHTML = '<option value="">All Zones</option>';
            
            // Populate property class filter with hierarchical structure
            const usedClasses = new Set(allParcels.map(p => p.class_code).filter(c => c));
            const primaryClasses = getPrimaryClasses().filter(({code}) => usedClasses.has(code));
            
            // Sort by class code for consistent ordering
            primaryClasses.sort((a, b) => a.code.localeCompare(b.code));
            
            primaryClasses.forEach(({code, name}) => {
                const classInfo = propertyClassHierarchy[code];
                
                // Add primary class option
                if (usedClasses.has(code)) {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${name}`;
                    classFilter.appendChild(option);
                }
                
                // Add subclass options (indented)
                if (classInfo && classInfo.subclasses) {
                    classInfo.subclasses
                        .filter(sub => usedClasses.has(sub) && propertyClassHierarchy[sub])
                        .sort()
                        .forEach(subcode => {
                            const option = document.createElement('option');
                            option.value = subcode;
                            option.textContent = `  ${subcode} - ${propertyClassHierarchy[subcode].name}`;
                            classFilter.appendChild(option);
                        });
                }
            });
            
            // Populate year built filter
            const years = [...new Set(allParcels.map(p => p.year_built ? parseInt(p.year_built) : null).filter(y => y))].sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Populate zoning filter
            const zones = [...new Set(allParcels.map(p => p.zoning).filter(z => z))].sort();
            zones.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone;
                option.textContent = zone;
                zoneFilter.appendChild(option);
            });
        }

        // Apply filters
        function applyFilters() {
            const classFilterElement = document.getElementById('class-filter');
            const yearFilterElement = document.getElementById('year-built-filter');
            const zoneFilterElement = document.getElementById('zoning-filter');
            const minValue = parseNumber(document.getElementById('min-value').value);
            const maxValue = parseNumber(document.getElementById('max-value').value);

            // Get selected values from multi-select dropdowns
            const selectedClasses = Array.from(classFilterElement.selectedOptions).map(opt => opt.value).filter(v => v);
            const selectedYears = Array.from(yearFilterElement.selectedOptions).map(opt => opt.value).filter(v => v);
            const selectedZones = Array.from(zoneFilterElement.selectedOptions).map(opt => opt.value).filter(v => v);

            filteredParcels = allParcels.filter(parcel => {
                // Class filter with hierarchical support
                if (selectedClasses.length > 0) {
                    const allowedClasses = getClassesForFilter(selectedClasses);
                    if (!allowedClasses.includes(parcel.class_code)) {
                        return false;
                    }
                }
                
                // Year built filter (multiple selection)
                if (selectedYears.length > 0 && !selectedYears.includes(String(parseInt(parcel.year_built) || ''))) {
                    return false;
                }
                
                // Zoning filter (multiple selection)
                if (selectedZones.length > 0 && !selectedZones.includes(parcel.zoning)) {
                    return false;
                }

                // Value filters
                const value = parseNumber(parcel.total_value);
                if (minValue > 0 && value < minValue) return false;
                if (maxValue > 0 && value > maxValue) return false;

                return true;
            });

            renderTable();
            updateFilterStats();
            document.getElementById('filtered-count').textContent = formatNumber(filteredParcels.length);
        }

        // Handle property selection for comparison
        function handlePropertyClick(parcelId, event) {
            if (!comparisonMode) return;
            
            event.stopPropagation();
            
            if (selectedProperties.has(parcelId)) {
                selectedProperties.delete(parcelId);
                event.currentTarget.classList.remove('selected');
            } else {
                if (selectedProperties.size < 4) { // Limit to 4 properties
                    selectedProperties.add(parcelId);
                    event.currentTarget.classList.add('selected');
                }
            }
            
            updateSelectedCount();
            updateComparisonPanel();
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('parcels-table');
            
            if (filteredParcels.length === 0) {
                tbody.innerHTML = '<tr><td colspan="19" class="no-results">No properties match your criteria</td></tr>';
                return;
            }

            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const rows = filteredParcels.slice(startIndex, endIndex).map(parcel => {
                const isSelected = selectedProperties.has(parcel.parcel_id);
                return `
                <tr class="${comparisonMode ? 'property-select' : ''} ${isSelected ? 'selected' : ''}" 
                    onclick="handlePropertyClick('${parcel.parcel_id}', event)" 
                    style="${comparisonMode ? 'cursor: pointer;' : ''}">
                    <td>${parcel.parcel_id || ''}</td>
                    <td>${parcel.owner_name || ''}</td>
                    <td>${parcel.class_code || ''}</td>
                    <td>${parcel.zoning || '‚Äî'}</td>
                    <td>${parcel.building_style || '‚Äî'}</td>
                    <td>${parcel.building_grade || '‚Äî'}</td>
                    <td>${parcel.year_built ? parseInt(parcel.year_built) : '‚Äî'}</td>
                    <td>${formatNumber(parcel.living_area_sqft) || '‚Äî'}</td>
                    <td>${parcel.bedrooms || '‚Äî'}</td>
                    <td>${parcel.total_rooms || '‚Äî'}</td>
                    <td>${parcel.full_baths || '‚Äî'}</td>
                    <td>${parcel.half_baths || '‚Äî'}</td>
                    <td>${parcel.heating_type || '‚Äî'}</td>
                    <td>${parcel.heating_fuel || '‚Äî'}</td>
                    <td>${parcel.neighborhood || '‚Äî'}</td>
                    <td>${parcel.lot_size_acres || ''}</td>
                    <td class="currency">${formatCurrency(parcel.land_value)}</td>
                    <td class="currency">${formatCurrency(parcel.building_value)}</td>
                    <td class="currency">${formatCurrency(parcel.total_value)}</td>
                </tr>
            `;}).join('');

            tbody.innerHTML = rows;
            
            updatePagination();
        }

        // Pagination variables
        let currentPage = 1;
        const rowsPerPage = 200; /* Optimize for better performance */
        
        // Update pagination controls
        function updatePagination() {
            const totalPages = Math.ceil(filteredParcels.length / rowsPerPage);
            const paginationDiv = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationDiv.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo; Prev</button>`;
            
            // Page numbers
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }
            
            // Next button
            paginationHTML += `<button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next &raquo;</button>`;
            
            // Page info
            const startIndex = (currentPage - 1) * rowsPerPage + 1;
            const endIndex = Math.min(currentPage * rowsPerPage, filteredParcels.length);
            // Add function buttons inline with pagination
            paginationHTML += `
                <span style="margin: 0 16px; color: #666;">Showing ${startIndex}-${endIndex} of ${formatNumber(filteredParcels.length)} properties</span>
                <button class="btn btn-success" onclick="exportFilteredData()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">üìä Export</button>
                <button class="btn btn-warning" onclick="toggleAnalytics()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">üìà Analytics</button>
                <button class="btn" onclick="toggleComparison()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">‚öñÔ∏è Compare</button>
            `;
            
            paginationDiv.innerHTML = paginationHTML;
        }
        
        // Go to page function
        function goToPage(page) {
            const totalPages = Math.ceil(filteredParcels.length / rowsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderTable();
        }
        
        // Add filter statistics
        function updateFilterStats() {
            const statsDiv = document.getElementById('filter-stats');
            if (!filteredParcels.length || filteredParcels.length === allParcels.length) {
                statsDiv.style.display = 'none';
                return;
            }
            
            const totalValue = filteredParcels.reduce((sum, p) => sum + (parseNumber(p.total_value) || 0), 0);
            const allTotalValue = allParcels.reduce((sum, p) => sum + (parseNumber(p.total_value) || 0), 0);
            
            const parcelPercent = ((filteredParcels.length / allParcels.length) * 100).toFixed(1);
            const valuePercent = allTotalValue > 0 ? ((totalValue / allTotalValue) * 100).toFixed(1) : '0.0';
            
            statsDiv.innerHTML = `
                <strong>Filtered Results:</strong> ${parcelPercent}% of parcels (${formatNumber(filteredParcels.length)} of ${formatNumber(allParcels.length)}) 
                representing ${valuePercent}% of total city value ($${formatLargeNumber(totalValue)} of $${formatLargeNumber(allTotalValue)})
            `;
            statsDiv.style.display = 'block';
        }
        
        // Export filtered data as CSV
        function exportFilteredData() {
            const headers = ['parcel_id', 'owner_name', 'class_code', 'zoning', 'building_style', 'building_grade', 'year_built', 'living_area_sqft', 'bedrooms', 'total_rooms', 'full_baths', 'half_baths', 'heating_type', 'heating_fuel', 'neighborhood', 'lot_size_acres', 'land_value', 'building_value', 'total_value'];
            let csvContent = headers.join(',') + '\n';
            
            filteredParcels.forEach(parcel => {
                const row = headers.map(header => {
                    let value = parcel[header] || '';
                    // Escape values containing commas or quotes
                    if (value.includes(',') || value.includes('"')) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lebanon-property-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Toggle analytics panel
        function toggleAnalytics() {
            const panel = document.getElementById('analytics-panel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateAnalytics();
            }
        }
        
        // Update analytics with current data
        function updateAnalytics() {
            // Value distribution
            const valueRanges = [
                { label: 'Under $200K', min: 0, max: 200000 },
                { label: '$200K - $500K', min: 200000, max: 500000 },
                { label: '$500K - $1M', min: 500000, max: 1000000 },
                { label: 'Over $1M', min: 1000000, max: Infinity }
            ];
            
            let valueDistHtml = '';
            valueRanges.forEach(range => {
                const count = filteredParcels.filter(p => {
                    const val = parseNumber(p.total_value);
                    return val >= range.min && val < range.max;
                }).length;
                const percent = filteredParcels.length ? ((count / filteredParcels.length) * 100).toFixed(1) : 0;
                valueDistHtml += `<div>${range.label}: ${count} (${percent}%)</div>`;
            });
            document.getElementById('value-distribution').innerHTML = valueDistHtml;
            
            // Property classes
            const classCounts = {};
            filteredParcels.forEach(p => {
                const cls = p.class_code || 'Unknown';
                classCounts[cls] = (classCounts[cls] || 0) + 1;
            });
            
            let classHtml = '';
            Object.entries(classCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .forEach(([cls, count]) => {
                    const percent = ((count / filteredParcels.length) * 100).toFixed(1);
                    classHtml += `<div>Class ${cls}: ${count} (${percent}%)</div>`;
                });
            document.getElementById('class-breakdown').innerHTML = classHtml;
            
            // Size analysis
            const avgAcres = filteredParcels.reduce((sum, p) => sum + parseFloat(p.lot_size_acres || 0), 0) / filteredParcels.length;
            const avgValue = filteredParcels.reduce((sum, p) => sum + parseNumber(p.total_value), 0) / filteredParcels.length;
            const avgValuePerAcre = avgAcres > 0 ? avgValue / avgAcres : 0;
            
            const sizeHtml = `
                <div>Avg Lot Size: ${avgAcres.toFixed(2)} acres</div>
                <div>Avg Value: ${formatCurrency(avgValue)}</div>
                <div>Value/Acre: ${formatCurrency(avgValuePerAcre)}</div>
            `;
            document.getElementById('size-analysis').innerHTML = sizeHtml;
            
            // Market insights
            const medianValue = getMedianValue(filteredParcels);
            const highValue = Math.max(...filteredParcels.map(p => parseNumber(p.total_value)));
            const lowValue = Math.min(...filteredParcels.map(p => parseNumber(p.total_value)).filter(v => v > 0));
            
            const insightsHtml = `
                <div>Median: ${formatCurrency(medianValue)}</div>
                <div>Highest: ${formatCurrency(highValue)}</div>
                <div>Lowest: ${formatCurrency(lowValue)}</div>
            `;
            document.getElementById('market-insights').innerHTML = insightsHtml;
        }
        
        function getMedianValue(parcels) {
            const values = parcels.map(p => parseNumber(p.total_value)).filter(v => v > 0).sort((a, b) => a - b);
            return values.length > 0 ? values[Math.floor(values.length / 2)] : 0;
        }
        
        // Toggle comparison mode
        function toggleComparison() {
            comparisonMode = !comparisonMode;
            const countEl = document.getElementById('comparison-count');
            countEl.style.display = comparisonMode ? 'inline' : 'none';
            
            if (!comparisonMode) {
                selectedProperties.clear();
                document.getElementById('compare-panel').style.display = 'none';
                updateSelectedCount();
                // Remove selection styling
                document.querySelectorAll('.property-select').forEach(row => {
                    row.classList.remove('selected');
                });
            } else {
                updateComparisonPanel();
            }
        }
        
        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = selectedProperties.size;
        }
        
        function updateComparisonPanel() {
            const panel = document.getElementById('compare-panel');
            const content = document.getElementById('comparison-content');
            
            if (selectedProperties.size === 0) {
                content.innerHTML = '<p style="color: #666;">Select properties from the table below to compare them side by side.</p>';
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            let compareHtml = '<div class="compare-grid">';
            selectedProperties.forEach(parcelId => {
                const property = allParcels.find(p => p.parcel_id === parcelId);
                if (property) {
                    compareHtml += `
                        <div class="compare-property">
                            <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${property.owner_name} (${property.parcel_id})</h4>
                            <div><strong>Class:</strong> ${property.class_code}</div>
                            <div><strong>Year Built:</strong> ${property.year_built || '‚Äî'}</div>
                            <div><strong>Living Area:</strong> ${formatNumber(property.living_area_sqft) || '‚Äî'} sqft</div>
                            <div><strong>Bedrooms:</strong> ${property.bedrooms || '‚Äî'}</div>
                            <div><strong>Lot Size:</strong> ${property.lot_size_acres} acres</div>
                            <div><strong>Land Value:</strong> ${formatCurrency(property.land_value)}</div>
                            <div><strong>Building Value:</strong> ${formatCurrency(property.building_value)}</div>
                            <div><strong>Total Value:</strong> ${formatCurrency(property.total_value)}</div>
                        </div>
                    `;
                }
            });
            compareHtml += '</div>';
            
            content.innerHTML = compareHtml;
        }
        
        
        // Clear all filters
        function clearFilters() {
            // Clear multi-select dropdowns
            document.getElementById('class-filter').selectedIndex = -1;
            document.getElementById('year-built-filter').selectedIndex = -1;
            document.getElementById('zoning-filter').selectedIndex = -1;
            document.getElementById('min-value').value = '';
            document.getElementById('max-value').value = '';
            currentPage = 1;
            applyFilters();
        }
        
        // Event listeners
        document.getElementById('class-filter').addEventListener('change', () => { currentPage = 1; applyFilters(); });
        document.getElementById('year-built-filter').addEventListener('change', () => { currentPage = 1; applyFilters(); });
        document.getElementById('zoning-filter').addEventListener('change', () => { currentPage = 1; applyFilters(); });
        document.getElementById('min-value').addEventListener('input', () => { currentPage = 1; applyFilters(); });
        document.getElementById('max-value').addEventListener('input', () => { currentPage = 1; applyFilters(); });

        // Column resizing functionality
        let isResizing = false;
        let currentColumn = null;
        let startX = 0;
        let startWidth = 0;

        function initializeColumnResizing() {
            const table = document.querySelector('.table-container table');
            const headers = table.querySelectorAll('th');
            
            headers.forEach((header, index) => {
                // Add resizer div
                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                header.appendChild(resizer);
                
                // Add resize functionality
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isResizing = true;
                    currentColumn = index;
                    startX = e.clientX;
                    startWidth = header.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const newWidth = startWidth + diff;
                const minWidth = 60;
                
                if (newWidth > minWidth) {
                    const headers = table.querySelectorAll('th');
                    const cells = table.querySelectorAll(`td:nth-child(${currentColumn + 1})`);
                    
                    headers[currentColumn].style.width = newWidth + 'px';
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                    });
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentColumn = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Initialize
        loadParcels();
        
        // Load data function
        async function loadParcels() {
            try {
                const response = await fetch('data/parcels.csv');
                const text = await response.text();
                console.log('Raw CSV length:', text.length);
                
                // Parse CSV properly handling quoted fields
                const lines = text.trim().split('\n');
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                allParcels = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const parcel = {};
                    headers.forEach((header, index) => {
                        parcel[header] = values[index] || '';
                    });
                    return parcel;
                }).filter(p => p.parcel_id && p.parcel_id.trim());

                console.log(`Loaded ${allParcels.length} parcels`);
                if (allParcels.length > 0) {
                    console.log('First parcel:', allParcels[0]);
                }
                updateStats();
                populateFilters();
                applyFilters();
                
                // Initialize column resizing after table is rendered
                setTimeout(initializeColumnResizing, 100);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('parcels-table').innerHTML = '<tr><td colspan="19" class="no-results">Error loading data</td></tr>';
            }
        }
    </script>
</body>
</html>