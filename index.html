<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lebanon Property Tax Database</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header-left h1 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        .header-left p {
            margin: 2px 0 0 0;
            font-size: 0.75em;
            opacity: 0.9;
        }
        .header-right .btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 0.85em;
        }
        .header-right .btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 15px 20px;
        }
        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .controls {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin: 0 20px 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .control-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 12px; 
            align-items: flex-start;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 140px;
        }
        .control-label {
            font-size: 0.9em;
            color: #555;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input, select { 
            padding: 8px 10px; 
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
        }
        input[type="search"] {
            min-width: 150px;
        }
        .table-container {
            background: white;
            border-radius: 6px;
            overflow-y: auto;
            overflow-x: hidden; /* Hide the built-in scrollbar */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 90px; /* Space for fixed pagination and scrollbar */
            height: 55vh; /* Reduced viewport height */
            border: 1px solid #e1e5e9;
        }
        .horizontal-scroll {
            position: fixed;
            bottom: 45px;
            left: 20px;
            right: 20px;
            height: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 3px;
            z-index: 999;
        }
        .scroll-content {
            height: 1px;
            min-width: 1600px; /* Match table min-width */
        }
        .pagination {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid #e1e5e9;
            padding: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .page-btn:hover { background: #f5f5f5; }
        .page-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .filter-stats {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 0.9em;
            color: #1976d2;
            display: none;
        }
        table { 
            width: 100%; 
            min-width: 1600px;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td { 
            padding: 4px 6px; 
            text-align: left; 
            border-bottom: 0.5px solid #e1e5e9;
            font-size: 0.7em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            line-height: 1.1;
        }
        th { 
            background: #f8f9fa; 
            font-weight: 600;
            position: sticky; 
            top: 0;
            color: #2c3e50;
            cursor: col-resize;
            user-select: none;
            min-width: 70px;
            border-bottom: 1px solid #dee2e6;
            z-index: 10;
            font-size: 0.68em;
        }
        th:hover {
            background: #e9ecef;
        }
        .column-resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: col-resize;
            z-index: 15;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        .no-results {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #27ae60;
        }
        .btn-success:hover {
            background: #229954;
        }
        .btn-warning {
            background: #f39c12;
        }
        .btn-warning:hover {
            background: #e67e22;
        }
        .action-buttons {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .analytics-panel {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .compare-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #2c3e50;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .compare-property {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
        }
        .compare-property div {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .compare-property strong {
            color: #2c3e50;
        }
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        .analytics-card {
            background: white;
            padding: 16px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .analytics-card h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            .action-buttons {
                justify-content: center;
            }
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        .dropdown-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            min-height: 20px;
            transition: border-color 0.2s;
        }
        .dropdown-button:hover {
            border-color: #2196f3;
        }
        .dropdown-button.active {
            border-color: #2196f3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }
        .dropdown-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #333;
        }
        .dropdown-arrow {
            color: #666;
            font-size: 0.8em;
            transition: transform 0.2s;
        }
        .dropdown-button.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        .dropdown-menu {
            position: fixed;
            background: white;
            border: 2px solid #2196f3;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            min-width: 200px;
        }
        .dropdown-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dropdown-option:hover {
            background: #f8f9fa;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option input[type="checkbox"] {
            margin: 0 8px 0 0;
            width: auto;
        }
        .dropdown-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9em;
            margin: 0;
        }
    </style>
    <script src="js/shared-filters.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Lebanon Property Tax Database</h1>
            <p>Comprehensive property assessment data for the City of Lebanon, NH</p>
        </div>
        <div class="header-right">
            <a href="map.html" class="btn">🗺️ View Map</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-parcels">0</div>
            <div class="stat-label">Total Parcels</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-value">$0</div>
            <div class="stat-label">Total Assessed Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="median-value">$0</div>
            <div class="stat-label">Median Property Value</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="property-classes">0</div>
            <div class="stat-label">Property Classes</div>
        </div>
    </div>

    <div class="controls">
        <div class="control-row">
            <button class="btn" onclick="clearFilters()" style="margin-right: 15px; align-self: flex-end; margin-bottom: 6px;">🔄 Reset Filters</button>
            <div class="control-group">
                <div class="control-label">Property Class <small style="color: #888;">(Click for options)</small></div>
                <div class="custom-dropdown" id="class-dropdown">
                    <div class="dropdown-button" onclick="toggleDropdown('class')">
                        <span class="dropdown-text" id="class-text">All Classes</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-menu" id="class-menu">
                        <div class="dropdown-option" data-value="">
                            <input type="checkbox" id="class-all" checked>
                            <label for="class-all">All Classes</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">Year Built <small style="color: #888;">(Click for options)</small></div>
                <div class="custom-dropdown" id="year-dropdown">
                    <div class="dropdown-button" onclick="toggleDropdown('year')">
                        <span class="dropdown-text" id="year-text">All Years</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-menu" id="year-menu">
                        <div class="dropdown-option" data-value="">
                            <input type="checkbox" id="year-all" checked>
                            <label for="year-all">All Years</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">Zone <small style="color: #888;">(Click for options)</small></div>
                <div class="custom-dropdown" id="zone-dropdown">
                    <div class="dropdown-button" onclick="toggleDropdown('zone')">
                        <span class="dropdown-text" id="zone-text">All Zones</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-menu" id="zone-menu">
                        <div class="dropdown-option" data-value="">
                            <input type="checkbox" id="zone-all" checked>
                            <label for="zone-all">All Zones</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">Min Value ($)</div>
                <input id="min-value" type="number" placeholder="0" style="width: 100%;">
            </div>
            <div class="control-group">
                <div class="control-label">Max Value ($)</div>
                <input id="max-value" type="number" placeholder="Any" style="width: 100%;">
            </div>
        </div>
        <div style="color: #666; font-size: 0.9em;">
            Showing <span id="filtered-count">0</span> properties
            <span id="comparison-count" style="margin-left: 16px; color: #2196f3; display: none;">📋 <span id="selected-count">0</span> selected for comparison</span>
        </div>
    </div>

    <div id="compare-panel" class="compare-panel" style="margin: 0 20px 20px 20px; display: none;">
        <h3 style="margin: 0 0 16px 0; color: #2c3e50;">Property Comparison</h3>
        <div id="comparison-content"></div>
    </div>

    <div class="table-container" style="margin: 0 20px;">
        <table id="data-table">
            <thead>
                <tr id="table-headers">
                    <th style="width: 70px;">Parcel ID</th>
                    <th style="width: 180px;">Owner</th>
                    <th style="width: 60px;">Class</th>
                    <th style="width: 70px;">Zone</th>
                    <th style="width: 80px;">Style</th>
                    <th style="width: 70px;">Grade</th>
                    <th style="width: 70px;">Year Built</th>
                    <th style="width: 80px;">Living Area (sqft)</th>
                    <th style="width: 70px;">Bedrooms</th>
                    <th style="width: 70px;">Total Rooms</th>
                    <th style="width: 70px;">Full Baths</th>
                    <th style="width: 70px;">Half Baths</th>
                    <th style="width: 80px;">Heat Type</th>
                    <th style="width: 70px;">Fuel</th>
                    <th style="width: 80px;">Neighborhood</th>
                    <th style="width: 80px;">Lot Size (acres)</th>
                    <th style="width: 100px;">Land Value</th>
                    <th style="width: 100px;">Building Value</th>
                    <th style="width: 100px;">Total Value</th>
                </tr>
            </thead>
            <tbody id="parcels-table">
                <tr><td colspan="19" class="no-results">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div class="horizontal-scroll" id="horizontal-scroll">
        <div class="scroll-content" id="scroll-content"></div>
    </div>

    <div id="analytics-panel" class="analytics-panel" style="margin: 0 20px 20px 20px; display: none;">
        <h3 style="margin: 0 0 16px 0;">Data Analytics</h3>
        <div id="analytics-content"></div>
    </div>

    <div class="pagination" id="pagination"></div>

    <script>
        let allParcels = [];
        let filteredParcels = [];
        let currentPage = 1;
        const rowsPerPage = 200;

        // Enhanced features variables
        let selectedProperties = new Set();
        let comparisonMode = false;
        
        // Custom dropdown functionality
        let openDropdown = null;
        let selectedFilters = {
            class: [],
            year: [],
            zone: []
        };

        // Parse CSV line handling quoted fields properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        // Hierarchical property class structure for Lebanon, NH (standardized with map page)
        const propertyClassHierarchy = {
            '013R': { name: 'Seasonal Residential', primary: true },
            '0310': { name: 'Seasonal Land', primary: true },
            '0430': { name: 'Forest Land', primary: true },
            '1010': {
                name: 'Residential Single Family',
                primary: true,
                subclasses: ['1012', '101A', '101C', '101T']
            },
            '1012': { name: 'Residential Multi-Unit', parent: '1010' },
            '101A': { name: 'Residential Accessory', parent: '1010' },
            '101C': { name: 'Residential Commercial', parent: '1010' },
            '101T': { name: 'Residential Temp', parent: '1010' },
            
            '1020': {
                name: 'Manufactured Housing',
                primary: true,
                subclasses: ['102C', '102V']
            },
            '102C': { name: 'Manufactured Commercial', parent: '1020' },
            '102V': { name: 'Manufactured Village', parent: '1020' },
            
            '2010': {
                name: 'Commercial/Industrial',
                primary: true,
                subclasses: ['2020', '201C', '2030', '2040', '204C', '2050', '2060', '2070', '2080', '2090']
            },
            '2020': { name: 'Retail/Service', parent: '2010' },
            '201C': { name: 'Commercial Condo', parent: '2010' },
            '2030': { name: 'Office', parent: '2010' },
            '2040': { name: 'Industrial', parent: '2010' },
            '204C': { name: 'Industrial Condo', parent: '2010' },
            '2050': { name: 'Warehouse', parent: '2010' },
            '2060': { name: 'Special Purpose', parent: '2010' },
            '2070': { name: 'Mixed Use', parent: '2010' },
            '2080': { name: 'Auto Related', parent: '2010' },
            '2090': { name: 'Restaurant/Hotel', parent: '2010' },
            
            '3520': { name: 'Wild/Forest Land', primary: true },
            '3530': { name: 'Recreation Land', primary: true },
            '3540': { name: 'Cemeteries', primary: true },
            '354C': { name: 'Cemetery Commercial', parent: '3540' },
            '3550': { name: 'Other Land', primary: true },
            '4100': { name: 'Government/Municipal', primary: true },
            '5010': { name: 'Religious/Educational', primary: true },
            '9200': { name: 'Hospital', primary: true }
        };

        const lebanonClassCodes = Object.keys(propertyClassHierarchy);

        // Helper functions for property classes
        function getPrimaryClasses() {
            return Object.entries(propertyClassHierarchy)
                .filter(([code, info]) => info.primary)
                .map(([code, info]) => ({ code, name: info.name }));
        }
        
        function getClassesForFilter(selectedClasses) {
            const result = [];
            selectedClasses.forEach(selectedClass => {
                const classInfo = propertyClassHierarchy[selectedClass];
                if (!classInfo) {
                    result.push(selectedClass);
                    return;
                }
                
                // If it's a primary class with subclasses, include all subclasses
                if (classInfo.primary && classInfo.subclasses) {
                    result.push(selectedClass, ...classInfo.subclasses);
                } else {
                    result.push(selectedClass);
                }
            });
            return [...new Set(result)]; // Remove duplicates
        }

        // Dropdown functions
        function toggleDropdown(type) {
            const menu = document.getElementById(type + '-menu');
            const button = document.querySelector('#' + type + '-dropdown .dropdown-button');
            
            // Close any other open dropdown
            if (openDropdown && openDropdown !== type) {
                closeDropdown(openDropdown);
            }
            
            if (menu.style.display === 'block') {
                closeDropdown(type);
            } else {
                openDropdownMenu(type);
            }
        }
        
        function openDropdownMenu(type) {
            const menu = document.getElementById(type + '-menu');
            const button = document.querySelector('#' + type + '-dropdown .dropdown-button');
            const rect = button.getBoundingClientRect();
            const footer = document.querySelector('.pagination');
            const footerRect = footer.getBoundingClientRect();
            
            // Position above footer
            menu.style.bottom = (window.innerHeight - footerRect.top + 10) + 'px';
            menu.style.left = rect.left + 'px';
            menu.style.width = rect.width + 'px';
            menu.style.display = 'block';
            
            button.classList.add('active');
            openDropdown = type;
        }
        
        function closeDropdown(type) {
            const menu = document.getElementById(type + '-menu');
            const button = document.querySelector('#' + type + '-dropdown .dropdown-button');
            
            menu.style.display = 'none';
            button.classList.remove('active');
            if (openDropdown === type) {
                openDropdown = null;
            }
        }
        
        function updateDropdownText(type) {
            const textElement = document.getElementById(type + '-text');
            const selected = selectedFilters[type];
            
            if (selected.length === 0) {
                let defaultText = 'All Classes';
                if (type === 'year') defaultText = 'All Years';
                if (type === 'zone') defaultText = 'All Zones';
                
                textElement.textContent = defaultText;
                textElement.style.color = '#666';
            } else if (selected.length === 1) {
                if (type === 'class' && propertyClassHierarchy[selected[0]]) {
                    textElement.textContent = selected[0] + ' - ' + propertyClassHierarchy[selected[0]].name;
                } else {
                    textElement.textContent = selected[0];
                }
                textElement.style.color = '#333';
            } else {
                textElement.textContent = selected.length + ' selected';
                textElement.style.color = '#333';
            }
        }
        
        function handleDropdownSelection(type, value, checked) {
            const menu = document.getElementById(type + '-menu');
            const allCheckbox = document.getElementById(type + '-all');
            
            if (value === '') {
                // "All" option selected
                if (checked) {
                    // Uncheck all other options and clear the array
                    const otherCheckboxes = menu.querySelectorAll('input[type="checkbox"]:not(#' + type + '-all)');
                    otherCheckboxes.forEach(cb => cb.checked = false);
                    selectedFilters[type] = [];
                } else {
                    // "All" unchecked, keep current selections
                }
            } else {
                // Specific option selected
                if (checked) {
                    // Uncheck "All" option first
                    if (allCheckbox) allCheckbox.checked = false;
                    
                    // Check if this is a primary class with subclasses
                    const classInfo = propertyClassHierarchy[value];
                    if (classInfo && classInfo.primary && classInfo.subclasses) {
                        // Primary class selected - add it and all its subclasses
                        if (!selectedFilters[type].includes(value)) {
                            selectedFilters[type].push(value);
                        }
                        classInfo.subclasses.forEach(subclass => {
                            if (!selectedFilters[type].includes(subclass)) {
                                selectedFilters[type].push(subclass);
                            }
                            // Check the subclass checkbox in the UI
                            const subCheckbox = document.getElementById(type + '-' + subclass);
                            if (subCheckbox) subCheckbox.checked = true;
                        });
                    } else {
                        // Regular class or subclass selected
                        if (!selectedFilters[type].includes(value)) {
                            selectedFilters[type].push(value);
                        }
                        
                        // If this is a subclass, check if all subclasses of its parent are now selected
                        const parentClass = Object.keys(propertyClassHierarchy).find(key => {
                            const info = propertyClassHierarchy[key];
                            return info.subclasses && info.subclasses.includes(value);
                        });
                        
                        if (parentClass) {
                            const parentInfo = propertyClassHierarchy[parentClass];
                            const allSubclassesSelected = parentInfo.subclasses.every(sub => 
                                selectedFilters[type].includes(sub)
                            );
                            
                            if (allSubclassesSelected && !selectedFilters[type].includes(parentClass)) {
                                selectedFilters[type].push(parentClass);
                                const parentCheckbox = document.getElementById(type + '-' + parentClass);
                                if (parentCheckbox) parentCheckbox.checked = true;
                            }
                        }
                    }
                } else {
                    // Remove from selection
                    selectedFilters[type] = selectedFilters[type].filter(v => v !== value);
                    
                    // Check if this is a primary class being unchecked
                    const classInfo = propertyClassHierarchy[value];
                    if (classInfo && classInfo.primary && classInfo.subclasses) {
                        // Primary class unchecked - remove all its subclasses
                        classInfo.subclasses.forEach(subclass => {
                            selectedFilters[type] = selectedFilters[type].filter(v => v !== subclass);
                            // Uncheck the subclass checkbox in the UI
                            const subCheckbox = document.getElementById(type + '-' + subclass);
                            if (subCheckbox) subCheckbox.checked = false;
                        });
                    } else {
                        // Subclass unchecked - uncheck its parent if it was checked
                        const parentClass = Object.keys(propertyClassHierarchy).find(key => {
                            const info = propertyClassHierarchy[key];
                            return info.subclasses && info.subclasses.includes(value);
                        });
                        
                        if (parentClass && selectedFilters[type].includes(parentClass)) {
                            selectedFilters[type] = selectedFilters[type].filter(v => v !== parentClass);
                            const parentCheckbox = document.getElementById(type + '-' + parentClass);
                            if (parentCheckbox) parentCheckbox.checked = false;
                        }
                    }
                    
                    // If no selections left, check "All" option
                    if (selectedFilters[type].length === 0 && allCheckbox) {
                        allCheckbox.checked = true;
                    }
                }
            }
            
            updateDropdownText(type);
            currentPage = 1;
            applyFilters();
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (openDropdown && !e.target.closest('#' + openDropdown + '-dropdown')) {
                closeDropdown(openDropdown);
            }
        });

        // Utility functions
        function parseNumber(str) {
            if (!str) return 0;
            return parseFloat(str.toString().replace(/[,$]/g, '')) || 0;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatLargeNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(0) + 'K';
            }
            return num.toString();
        }

        // Update statistics
        function updateStats() {
            const totalParcels = allParcels.length;
            const totalValue = allParcels.reduce((sum, p) => sum + parseNumber(p.total_value), 0);
            const values = allParcels.map(p => parseNumber(p.total_value)).filter(v => v > 0).sort((a, b) => a - b);
            const medianValue = values.length > 0 ? values[Math.floor(values.length / 2)] : 0;
            // Count only valid property class codes
            const validClasses = new Set(allParcels.map(p => p.class_code).filter(c => lebanonClassCodes.includes(c)));

            document.getElementById('total-parcels').textContent = formatNumber(totalParcels);
            document.getElementById('total-value').textContent = formatCurrency(totalValue);
            document.getElementById('median-value').textContent = formatCurrency(medianValue);
            document.getElementById('property-classes').textContent = formatNumber(validClasses.size);
        }

        // Populate filter dropdowns
        function populateFilters() {
            const classMenu = document.getElementById('class-menu');
            const yearMenu = document.getElementById('year-menu');
            const zoneMenu = document.getElementById('zone-menu');
            
            // Clear existing options (keep "All" options)
            classMenu.innerHTML = '<div class="dropdown-option" data-value=""><input type="checkbox" id="class-all" checked><label for="class-all">All Classes</label></div>';
            yearMenu.innerHTML = '<div class="dropdown-option" data-value=""><input type="checkbox" id="year-all" checked><label for="year-all">All Years</label></div>';
            zoneMenu.innerHTML = '<div class="dropdown-option" data-value=""><input type="checkbox" id="zone-all" checked><label for="zone-all">All Zones</label></div>';
            
            // Add event listeners for "All" checkboxes
            document.getElementById('class-all').addEventListener('change', (e) => {
                handleDropdownSelection('class', '', e.target.checked);
            });
            document.getElementById('year-all').addEventListener('change', (e) => {
                handleDropdownSelection('year', '', e.target.checked);
            });
            document.getElementById('zone-all').addEventListener('change', (e) => {
                handleDropdownSelection('zone', '', e.target.checked);
            });
            
            // Populate property class filter with hierarchical structure
            const usedClasses = new Set(allParcels.map(p => p.class_code).filter(c => c));
            const primaryClasses = getPrimaryClasses().filter(({code}) => usedClasses.has(code));
            
            // Sort by class code for consistent ordering
            primaryClasses.sort((a, b) => a.code.localeCompare(b.code));
            
            primaryClasses.forEach(({code, name}) => {
                const classInfo = propertyClassHierarchy[code];
                
                // Add primary class option
                if (usedClasses.has(code)) {
                    const option = document.createElement('div');
                    option.className = 'dropdown-option';
                    option.dataset.value = code;
                    option.innerHTML = '<input type="checkbox" id="class-' + code + '"><label for="class-' + code + '">' + code + ' - ' + name + '</label>';
                    classMenu.appendChild(option);
                    
                    // Add event listener
                    const checkbox = option.querySelector('input');
                    checkbox.addEventListener('change', (e) => {
                        handleDropdownSelection('class', code, e.target.checked);
                    });
                }
                
                // Add subclass options (indented)
                if (classInfo && classInfo.subclasses) {
                    classInfo.subclasses
                        .filter(sub => usedClasses.has(sub) && propertyClassHierarchy[sub])
                        .sort()
                        .forEach(subcode => {
                            const option = document.createElement('div');
                            option.className = 'dropdown-option';
                            option.dataset.value = subcode;
                            option.innerHTML = '<input type="checkbox" id="class-' + subcode + '"><label for="class-' + subcode + '" style="padding-left: 20px;">' + subcode + ' - ' + propertyClassHierarchy[subcode].name + '</label>';
                            classMenu.appendChild(option);
                            
                            // Add event listener
                            const checkbox = option.querySelector('input');
                            checkbox.addEventListener('change', (e) => {
                                handleDropdownSelection('class', subcode, e.target.checked);
                            });
                        });
                }
            });
            
            // Populate year built filter
            const years = [...new Set(allParcels.map(p => p.year_built ? parseInt(p.year_built) : null).filter(y => y))].sort((a, b) => b - a);
            years.forEach(year => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.dataset.value = year;
                option.innerHTML = '<input type="checkbox" id="year-' + year + '"><label for="year-' + year + '">' + year + '</label>';
                yearMenu.appendChild(option);
                
                // Add event listener
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    handleDropdownSelection('year', year.toString(), e.target.checked);
                });
            });
            
            // Populate zoning filter
            const zones = [...new Set(allParcels.map(p => p.zoning).filter(z => z))].sort();
            zones.forEach(zone => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.dataset.value = zone;
                option.innerHTML = '<input type="checkbox" id="zone-' + zone + '"><label for="zone-' + zone + '">' + zone + '</label>';
                zoneMenu.appendChild(option);
                
                // Add event listener
                const checkbox = option.querySelector('input');
                checkbox.addEventListener('change', (e) => {
                    handleDropdownSelection('zone', zone, e.target.checked);
                });
            });
        }

        // Apply filters
        function applyFilters() {
            const minValue = parseNumber(document.getElementById('min-value').value);
            const maxValue = parseNumber(document.getElementById('max-value').value);

            // Get selected values from custom dropdowns
            const selectedClasses = selectedFilters.class;
            const selectedYears = selectedFilters.year;
            const selectedZones = selectedFilters.zone;

            filteredParcels = allParcels.filter(parcel => {
                // Class filter with hierarchical support
                if (selectedClasses.length > 0) {
                    const allowedClasses = getClassesForFilter(selectedClasses);
                    if (!allowedClasses.includes(parcel.class_code)) {
                        return false;
                    }
                }
                
                // Year built filter (multiple selection)
                if (selectedYears.length > 0 && !selectedYears.includes(String(parseInt(parcel.year_built) || ''))) {
                    return false;
                }
                
                // Zoning filter (multiple selection)
                if (selectedZones.length > 0 && !selectedZones.includes(parcel.zoning)) {
                    return false;
                }

                // Value filters
                const value = parseNumber(parcel.total_value);
                if (minValue > 0 && value < minValue) return false;
                if (maxValue > 0 && value > maxValue) return false;

                return true;
            });

            renderTable();
            updateFilterStats();
            document.getElementById('filtered-count').textContent = formatNumber(filteredParcels.length);
        }

        // Render table
        function renderTable() {
            const tableBody = document.getElementById('parcels-table');
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredParcels.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="19" class="no-results">No properties match your filters</td></tr>';
                renderPagination();
                return;
            }

            let tableHTML = '';
            pageData.forEach(parcel => {
                const isSelected = selectedProperties.has(parcel.parcel_id);
                const rowClass = comparisonMode ? (isSelected ? 'selected' : '') : '';
                const clickHandler = comparisonMode ? 'onclick="handlePropertyClick(\'' + parcel.parcel_id + '\', event)"' : '';
                
                tableHTML += 
                    '<tr class="' + rowClass + '" ' + clickHandler + ' style="cursor: ' + (comparisonMode ? 'pointer' : 'default') + ';">' +
                        '<td title="' + parcel.parcel_id + '">' + parcel.parcel_id + '</td>' +
                        '<td title="' + parcel.owner_name + '">' + parcel.owner_name + '</td>' +
                        '<td title="' + parcel.class_code + '">' + parcel.class_code + '</td>' +
                        '<td title="' + parcel.zoning + '">' + parcel.zoning + '</td>' +
                        '<td title="' + parcel.building_style + '">' + (parcel.building_style || '') + '</td>' +
                        '<td title="' + parcel.building_grade + '">' + (parcel.building_grade || '') + '</td>' +
                        '<td title="' + parcel.year_built + '">' + (parseInt(parcel.year_built) || '—') + '</td>' +
                        '<td title="' + parcel.living_area_sqft + '">' + (formatNumber(parseNumber(parcel.living_area_sqft)) || '—') + '</td>' +
                        '<td title="' + parcel.bedrooms + '">' + (parcel.bedrooms || '—') + '</td>' +
                        '<td title="' + parcel.total_rooms + '">' + (parcel.total_rooms || '—') + '</td>' +
                        '<td title="' + parcel.full_baths + '">' + (parcel.full_baths || '—') + '</td>' +
                        '<td title="' + parcel.half_baths + '">' + (parcel.half_baths || '—') + '</td>' +
                        '<td title="' + parcel.heating_type + '">' + (parcel.heating_type || '') + '</td>' +
                        '<td title="' + parcel.heating_fuel + '">' + (parcel.heating_fuel || '') + '</td>' +
                        '<td title="' + parcel.neighborhood + '">' + (parcel.neighborhood || '') + '</td>' +
                        '<td title="' + parcel.lot_size_acres + '">' + (parcel.lot_size_acres || '') + '</td>' +
                        '<td title="' + formatCurrency(parseNumber(parcel.land_value)) + '">' + formatCurrency(parseNumber(parcel.land_value)) + '</td>' +
                        '<td title="' + formatCurrency(parseNumber(parcel.building_value)) + '">' + formatCurrency(parseNumber(parcel.building_value)) + '</td>' +
                        '<td title="' + formatCurrency(parseNumber(parcel.total_value)) + '">' + formatCurrency(parseNumber(parcel.total_value)) + '</td>' +
                    '</tr>';
            });

            tableBody.innerHTML = tableHTML;
            renderPagination();
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredParcels.length / rowsPerPage);
            const paginationDiv = document.getElementById('pagination');

            let paginationHTML = '';
            
            // Previous button
            paginationHTML += '<button class="page-btn" onclick="changePage(' + (currentPage - 1) + ')" ' + (currentPage <= 1 ? 'disabled' : '') + '>&laquo; Prev</button>';
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else if (endPage === totalPages) {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? ' active' : '';
                paginationHTML += '<button class="page-btn' + activeClass + '" onclick="changePage(' + i + ')">' + i + '</button>';
            }
            
            // Next button
            paginationHTML += '<button class="page-btn" onclick="changePage(' + (currentPage + 1) + ')" ' + (currentPage >= totalPages ? 'disabled' : '') + '>Next &raquo;</button>';
            
            // Add function buttons inline with pagination
            paginationHTML += 
                '<span style="margin: 0 16px; color: #666;">Showing ' + (((currentPage - 1) * rowsPerPage) + 1) + '-' + Math.min(currentPage * rowsPerPage, filteredParcels.length) + ' of ' + formatNumber(filteredParcels.length) + ' properties</span>' +
                '<button class="btn btn-success" onclick="exportFilteredData()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">📊 Export</button>' +
                '<button class="btn btn-warning" onclick="toggleAnalytics()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">📈 Analytics</button>' +
                '<button class="btn" onclick="toggleComparison()" style="padding: 4px 8px; font-size: 0.8em; margin: 0 4px;">⚖️ Compare</button>';
            
            paginationDiv.innerHTML = paginationHTML;
        }

        // Clear all filters
        function clearFilters() {
            // Reset all dropdown selections
            selectedFilters = { class: [], year: [], zone: [] };
            
            // Update dropdown texts
            updateDropdownText('class');
            updateDropdownText('year');
            updateDropdownText('zone');
            
            // Reset all checkboxes
            ['class', 'year', 'zone'].forEach(type => {
                const menu = document.getElementById(type + '-menu');
                const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                // Check the "All" option
                const allCheckbox = document.getElementById(type + '-all');
                if (allCheckbox) allCheckbox.checked = true;
            });
            
            document.getElementById('min-value').value = '';
            document.getElementById('max-value').value = '';
            currentPage = 1;
            applyFilters();
        }

        // Other functions...
        function changePage(page) {
            const totalPages = Math.ceil(filteredParcels.length / rowsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderTable();
            }
        }

        function exportFilteredData() {
            const headers = ['Parcel ID', 'Owner', 'Class', 'Zone', 'Style', 'Grade', 'Year Built', 'Living Area', 'Bedrooms', 'Total Rooms', 'Full Baths', 'Half Baths', 'Heat Type', 'Fuel', 'Neighborhood', 'Lot Size', 'Land Value', 'Building Value', 'Total Value'];
            const rows = [headers.join(',')];
            
            filteredParcels.forEach(parcel => {
                const row = [
                    '"' + parcel.parcel_id + '"',
                    '"' + parcel.owner_name + '"',
                    '"' + parcel.class_code + '"',
                    '"' + parcel.zoning + '"',
                    '"' + parcel.building_style + '"',
                    '"' + parcel.building_grade + '"',
                    parseInt(parcel.year_built) || '',
                    parseNumber(parcel.living_area_sqft) || '',
                    parcel.bedrooms || '',
                    parcel.total_rooms || '',
                    parcel.full_baths || '',
                    parcel.half_baths || '',
                    '"' + parcel.heating_type + '"',
                    '"' + parcel.heating_fuel + '"',
                    '"' + parcel.neighborhood + '"',
                    parcel.lot_size_acres || '',
                    parseNumber(parcel.land_value) || '',
                    parseNumber(parcel.building_value) || '',
                    parseNumber(parcel.total_value) || ''
                ];
                rows.push(row.join(','));
            });
            
            const csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lebanon_properties_' + new Date().toISOString().slice(0, 10) + '.csv';
            a.click();
            
            window.URL.revokeObjectURL(url);
        }

        function toggleAnalytics() {
            const panel = document.getElementById('analytics-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            
            if (panel.style.display === 'block') {
                generateAnalytics();
            }
        }

        function generateAnalytics() {
            const content = document.getElementById('analytics-content');
            
            // Calculate analytics
            const totalProperties = filteredParcels.length;
            const totalValue = filteredParcels.reduce((sum, p) => sum + parseNumber(p.total_value), 0);
            const avgValue = totalValue / totalProperties || 0;
            
            const classBreakdown = {};
            const yearBreakdown = {};
            
            filteredParcels.forEach(p => {
                classBreakdown[p.class_code] = (classBreakdown[p.class_code] || 0) + 1;
                const year = parseInt(p.year_built);
                if (year) {
                    const decade = Math.floor(year / 10) * 10;
                    yearBreakdown[decade] = (yearBreakdown[decade] || 0) + 1;
                }
            });
            
            let analyticsHTML = `
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h4>Summary Statistics</h4>
                        <div>Total Properties: ${formatNumber(totalProperties)}</div>
                        <div>Total Value: ${formatCurrency(totalValue)}</div>
                        <div>Average Value: ${formatCurrency(avgValue)}</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Top Property Classes</h4>
            `;
            
            Object.entries(classBreakdown)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .forEach(([cls, count]) => {
                    analyticsHTML += `<div>${cls}: ${count} properties</div>`;
                });
            
            analyticsHTML += `
                    </div>
                    <div class="analytics-card">
                        <h4>Construction by Decade</h4>
            `;
            
            Object.entries(yearBreakdown)
                .sort((a, b) => b[0] - a[0])
                .slice(0, 5)
                .forEach(([decade, count]) => {
                    analyticsHTML += `<div>${decade}s: ${count} properties</div>`;
                });
            
            analyticsHTML += '</div></div>';
            content.innerHTML = analyticsHTML;
        }

        function toggleComparison() {
            comparisonMode = !comparisonMode;
            const button = event.target;
            const countDisplay = document.getElementById('comparison-count');
            
            if (comparisonMode) {
                button.textContent = '❌ Exit Compare';
                button.style.background = '#e74c3c';
                countDisplay.style.display = 'inline';
                alert('Comparison mode enabled. Click on properties to compare them side by side (max 4).');
            } else {
                button.textContent = '⚖️ Compare';
                button.style.background = '#3498db';
                selectedProperties.clear();
                countDisplay.style.display = 'none';
                document.getElementById('compare-panel').style.display = 'none';
            }
            
            renderTable();
        }

        function handlePropertyClick(parcelId, event) {
            if (!comparisonMode) return;
            
            event.stopPropagation();
            
            if (selectedProperties.has(parcelId)) {
                selectedProperties.delete(parcelId);
                event.currentTarget.classList.remove('selected');
            } else {
                if (selectedProperties.size < 4) {
                    selectedProperties.add(parcelId);
                    event.currentTarget.classList.add('selected');
                } else {
                    alert('Maximum 4 properties can be compared at once.');
                }
            }
            
            updateComparisonCount();
            generateComparison();
        }

        function updateComparisonCount() {
            document.getElementById('selected-count').textContent = selectedProperties.size;
        }

        function updateFilterStats() {
            // Optional: Add filter statistics display
        }

        function generateComparison() {
            const panel = document.getElementById('compare-panel');
            const content = document.getElementById('comparison-content');
            
            if (selectedProperties.size === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            
            let compareHtml = '<div class="compare-grid">';
            selectedProperties.forEach(parcelId => {
                const property = allParcels.find(p => p.parcel_id === parcelId);
                if (property) {
                    compareHtml += `
                        <div class="compare-property">
                            <h4 style="margin: 0 0 8px 0; color: #2c3e50;">${property.owner_name} (${property.parcel_id})</h4>
                            <div><strong>Class:</strong> ${property.class_code}</div>
                            <div><strong>Year Built:</strong> ${property.year_built || '—'}</div>
                            <div><strong>Living Area:</strong> ${formatNumber(property.living_area_sqft) || '—'} sqft</div>
                            <div><strong>Bedrooms:</strong> ${property.bedrooms || '—'}</div>
                            <div><strong>Lot Size:</strong> ${property.lot_size_acres} acres</div>
                            <div><strong>Land Value:</strong> ${formatCurrency(property.land_value)}</div>
                            <div><strong>Building Value:</strong> ${formatCurrency(property.building_value)}</div>
                            <div><strong>Total Value:</strong> ${formatCurrency(property.total_value)}</div>
                        </div>
                    `;
                }
            });
            compareHtml += '</div>';
            
            content.innerHTML = compareHtml;
        }

        // Column resizing functionality
        let isResizing = false;
        let currentColumn = null;
        let startX = 0;
        let startWidth = 0;

        function initializeColumnResizing() {
            const table = document.querySelector('.table-container table');
            const headers = table.querySelectorAll('th');
            
            headers.forEach((header, index) => {
                // Add resizer div
                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                header.appendChild(resizer);
                
                // Add resize functionality
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isResizing = true;
                    currentColumn = index;
                    startX = e.clientX;
                    startWidth = header.offsetWidth;
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                });
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const diff = e.clientX - startX;
                const newWidth = startWidth + diff;
                const minWidth = 60;
                
                if (newWidth > minWidth) {
                    const headers = table.querySelectorAll('th');
                    const cells = table.querySelectorAll(`td:nth-child(${currentColumn + 1})`);
                    
                    headers[currentColumn].style.width = newWidth + 'px';
                    cells.forEach(cell => {
                        cell.style.width = newWidth + 'px';
                    });
                }
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    currentColumn = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        // Event listeners
        document.getElementById('min-value').addEventListener('input', () => { currentPage = 1; applyFilters(); });
        document.getElementById('max-value').addEventListener('input', () => { currentPage = 1; applyFilters(); });

        // Load data function
        function loadParcels() {
            return new Promise(async (resolve, reject) => {
            try {
                const response = await fetch('data/parcels.csv');
                const text = await response.text();
                console.log('Raw CSV length:', text.length);
                
                // Parse CSV properly handling quoted fields
                const lines = text.trim().split('\n');
                const headers = parseCSVLine(lines[0]);
                console.log('Headers:', headers);
                
                allParcels = lines.slice(1).map(line => {
                    const values = parseCSVLine(line);
                    const parcel = {};
                    headers.forEach((header, index) => {
                        parcel[header] = values[index] || '';
                    });
                    return parcel;
                }).filter(p => p.parcel_id && p.parcel_id.trim());

                console.log(`Loaded ${allParcels.length} parcels`);
                if (allParcels.length > 0) {
                    console.log('First parcel:', allParcels[0]);
                }
                updateStats();
                populateFilters();
                applyFilters();
                
                // Initialize column resizing after table is rendered
                setTimeout(initializeColumnResizing, 100);
                resolve();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('parcels-table').innerHTML = '<tr><td colspan="19" class="no-results">Error loading data</td></tr>';
                reject(error);
            }
            });
        }

        // Sync horizontal scrollbar with table
        function initializeScrollSync() {
            const tableContainer = document.querySelector('.table-container');
            const horizontalScroll = document.getElementById('horizontal-scroll');
            
            // Sync scrollbar with table horizontal scroll
            tableContainer.addEventListener('scroll', () => {
                horizontalScroll.scrollLeft = tableContainer.scrollLeft;
            });
            
            // Sync table with scrollbar scroll
            horizontalScroll.addEventListener('scroll', () => {
                tableContainer.scrollLeft = horizontalScroll.scrollLeft;
            });
        }

        // Initialize
        loadParcels().then(() => {
            setTimeout(initializeScrollSync, 500);
        });
    </script>
</body>
</html>